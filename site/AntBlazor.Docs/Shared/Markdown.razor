@using System.IO
@using System.Net
@using AntBlazor.Docs.Highlight
@using Markdig
@using Markdig.Extensions.Yaml
@using Markdig.Syntax
@using YamlDotNet.Serialization

@inherits ComponentBase
@inject HtmlRenderService HtmlRenderService
@inject HttpClient HttpClient
@inject IPrismHighlighter PrismHighlighter

<h1>@title</h1>

@((MarkupString)html)

@code {

    [Parameter] public string docUrl { get; set; }

    [Parameter] public string markdown { get; set; }

    [Parameter]
    public RenderFragment ChildContent { get; set; }

    string html { get; set; }

    string title { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(docUrl))
        {
            markdown = await this.HttpClient.GetStringAsync(docUrl);
        }

        if (ChildContent != null)
        {
            markdown = await HtmlRenderService.RenderAsync(ChildContent);
            markdown = WebUtility.HtmlDecode(markdown);
        }

        if (!string.IsNullOrEmpty(markdown))
        {
            markdown = markdown.Trim(' ', '\r', '\n');
            var pipeline = new MarkdownPipelineBuilder()
                .UseYamlFrontMatter()
                .UsePipeTables()
                .Build();

            StringWriter writer = new StringWriter();
            var renderer = new Markdig.Renderers.HtmlRenderer(writer);
            pipeline.Setup(renderer);

            MarkdownDocument document = Markdig.Markdown.Parse(markdown, pipeline);
            var yamlBlock= document.Descendants<YamlFrontMatterBlock>().FirstOrDefault();

            if (yamlBlock != null)
            {
                string yaml = markdown.Substring(yamlBlock.Span.Start, yamlBlock.Span.Length).Trim('-');
                var meta = new Deserializer().Deserialize<Dictionary<string, string>>(yaml);

                title = meta["title"];
            }

            renderer.Render(document);
            writer.Flush();
            html = writer.ToString();

        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await PrismHighlighter.HighlightAllAsync();
    }

}
